name: Move PR to column if not updated
on:
  schedule:
    - cron: "* */12 * * *"
  workflow_dispatch:
    
jobs:
  move-pr:
    runs-on: ubuntu-latest
    steps:
      - uses: monry/actions-get-project-id@v2
        id: get-project-id # requires `id` to refer output values with after steps
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          project-owner: 'rawlmp'
          project-number: 3
      - name: Move PR to column if not updated
        uses: actions/github-script@v4
        with:
          script: |
            const projects = await github.projects({owner: context.repo.owner});
            console.log(projects)
            const updatePR = async (pr) => {
              const { data: columns } = await github.projects.listColumns({
                project_id: ${{ steps.get-project-id.outputs.project-id }}
              });
              const timeSinceUpdate = new Date() - new Date(pr.updated_at);
              const twoMins = 2 * 60 * 1000;
              const columnName = "Draft not updated";
              const column = columns.find((column) => {
                console.log(column)
                return column.name === columnName
              });
              if (timeSinceUpdate > twoMins && column) {
                await github.projects.moveCard({
                  card_id: pr.head.repo_card.id,
                  position: "top",
                  column_id: column.id
                });
              }
            }

            const { data: prs } = await github.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              sort: 'updated',
              direction: 'desc',
              per_page: 100
            });

            prs.forEach(pr => {
              updatePR(pr);
            })
